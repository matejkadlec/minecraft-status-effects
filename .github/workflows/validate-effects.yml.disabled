name: Validate Effects JSON

on:
  push:
    paths:
      - "data/effects.json"
      - "scripts/validate_effects.py"
      - ".github/workflows/validate-effects.yml"
  pull_request:
    paths:
      - "data/effects.json"
      - "scripts/validate_effects.py"
      - ".github/workflows/validate-effects.yml"

jobs:
  order-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run effects validation
        id: validate
        run: |
          echo "ðŸ”Ž Running effects JSON validation"
          set -e
          mkdir -p logs
          python scripts/validate_effects.py | tee logs/validation.log
          echo "validation-log<<EOF" >> $GITHUB_OUTPUT
          sed 's/^/| /' logs/validation.log >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Publish summary
        if: success()
        run: |
          echo "## âœ… Effects JSON Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "All 10 checks passed: no empty fields, text formatting, no duplicates, ordering, max level format, description HTML tags, tags validation, source potion grouping, source HTML tags, source special terms." >> $GITHUB_STEP_SUMMARY
          echo "### Log Excerpt" >> $GITHUB_STEP_SUMMARY
          echo '\n\n' >> $GITHUB_STEP_SUMMARY
          sed 's/^/`/; s/$/`/' logs/validation.log | head -n 30 >> $GITHUB_STEP_SUMMARY

      - name: Publish failure summary
        if: failure()
        run: |
          echo "## âŒ Effects JSON Validation Failed" >> $GITHUB_STEP_SUMMARY
          echo "Check the step logs above for the first failing rule." >> $GITHUB_STEP_SUMMARY

      - name: Upload full validation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: effects-validation-log
          path: logs/validation.log
